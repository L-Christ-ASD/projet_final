---
- name: Mettre à jour les paquets
  apt:
    update_cache: yes
    upgrade: yes

- name: Désactiver swap (RKE2 exige que le swap soit désactivé)
  command: swapoff -a
  when: ansible_swaptotal_mb > 0

- name: Supprimer swap du fstab pour éviter qu'il ne se réactive au reboot
  replace:
    path: /etc/fstab
    regexp: '^\s*[^#].*\bswap\b.*$'
    replace: ''

- name: Mettre à jour le cache APT et installer les dépendances nécessaires
  apt:
    update_cache: yes
    name:
      - curl
      - iptables
      - socat
      - unzip
      - iproute2
    state: present

- name: Vérifier si RKE2 est déjà installé
  command: which rke2
  register: rke2_check
  ignore_errors: true
  changed_when: false

- name: Télécharger et exécuter le script d'installation de RKE2 si absent
  shell: curl -sfL https://get.rke2.io | INSTALL_RKE2_CHANNEL=stable INSTALL_RKE2_VERSION="v1.30.0+rke2r1" sh -
  when: rke2_check.rc != 0
